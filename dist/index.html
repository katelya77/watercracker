<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"/><meta name="build-version" content="2025-01-08-05"/><meta name="cache-control" content="no-cache, no-store, must-revalidate"/><meta http-equiv="pragma" content="no-cache"/><meta http-equiv="expires" content="0"/><link rel="icon" href="favicon.ico"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="description" content="深圳市常工电子&quot;蓝牙水控器&quot;控制程序的开源实现。适用于国内各大高校宿舍热水器。"/><meta name="theme-color" content="#fafafa"/><link rel="apple-touch-icon" href="logo192.png"/><link rel="manifest" href="manifest.json"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"><title>蓝牙水控器 FOSS</title><style>body{background:linear-gradient(135deg,#667eea 0,#764ba2 100%)!important;background-attachment:fixed!important;min-height:100vh!important;margin:0!important;padding:0!important;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif!important;overflow-x:hidden!important}.main{position:absolute!important;left:50%!important;top:50%!important;-webkit-transform:translate(-50%,-50%)!important;transform:translate(-50%,-50%)!important;display:flex!important;align-items:center!important;justify-content:center!important;flex-direction:column!important;background:rgba(255,255,255,.15)!important;backdrop-filter:blur(15px)!important;-webkit-backdrop-filter:blur(15px)!important;border-radius:25px!important;padding:40px 50px!important;border:2px solid rgba(255,255,255,.3)!important;box-shadow:0 15px 45px rgba(0,0,0,.2)!important;min-width:350px!important;max-width:500px!important;text-align:center!important;margin:0!important}.main h2{color:#fff!important;text-shadow:0 3px 6px rgba(0,0,0,.4)!important;margin-top:0!important;margin-bottom:15px!important;font-size:28px!important;font-weight:700!important}.main button{background:linear-gradient(45deg,#667eea,#764ba2)!important;color:#fff!important;border:none!important;padding:12px 30px!important;border-radius:25px!important;font-size:16px!important;font-weight:600!important;cursor:pointer!important;transition:all .3s ease!important;box-shadow:0 4px 15px rgba(0,0,0,.2)!important;margin:10px 0!important;pointer-events:auto!important;user-select:none!important;-webkit-user-select:none!important;-webkit-tap-highlight-color:transparent!important;position:relative!important;z-index:1!important}.main button:hover{transform:translateY(-2px)!important;box-shadow:0 8px 25px rgba(0,0,0,.3)!important;background:linear-gradient(45deg,#5a8ff0,#8959b8)!important}.main button:active{transform:translateY(0)!important;box-shadow:0 2px 10px rgba(0,0,0,.2)!important}.main button:disabled{opacity:.6!important;cursor:not-allowed!important;pointer-events:none!important}.main{pointer-events:auto!important}.main p{color:rgba(255,255,255,.9)!important;margin:8px 0!important;font-size:14px!important}.misc{position:fixed!important;bottom:20px!important;left:50%!important;transform:translateX(-50%)!important;text-align:center!important}.misc a{color:rgba(255,255,255,.7)!important;text-decoration:none!important;margin:0 5px!important}.misc a:hover{color:#fff!important;text-decoration:underline!important}</style></head><body><div class="main supported"><noscript>需要启用 JavaScript。</noscript><h2 style="margin-top:0;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.3)">🛀 蓝牙水控器</h2><p id="bluetooth-status" style="color:rgba(255,255,255,.8);font-size:14px;margin:5px 0">检测蓝牙支持中...</p><button id="main-button" onclick="try{window.startWaterController && window.startWaterController(); console.log('✅HTML内联点击成功');}catch(e){console.error('❌HTML内联失败:',e);}" data-onclick="startWaterController" style="pointer-events:auto!important;cursor:pointer!important">开启</button> <button id="clear-pairing-button" style="background:linear-gradient(45deg,#ff6b6b,#ee5a6f)!important;font-size:14px!important;padding:8px 20px!important;pointer-events:auto!important;cursor:pointer!important" onclick="try{window.clearPairedDevices && window.clearPairedDevices(); console.log('✅清除按钮HTML内联成功');}catch(e){console.error('❌清除按钮HTML内联失败:',e);}" data-onclick="clearPairedDevices">清除已配对设备</button><p id="device-name" style="margin-top:10px;margin-bottom:10px">未连接</p></div><script>// 立即执行蓝牙检测，不等待其他脚本加载
      (function() {
        async function quickBluetoothCheck() {
          const statusEl = document.getElementById("bluetooth-status");
          if (!statusEl) {
            setTimeout(quickBluetoothCheck, 50);
            return;
          }
          
          try {
            // 更严格的蓝牙检测
            if (typeof navigator === 'undefined' || !navigator.bluetooth) {
              statusEl.innerHTML = "❌ 浏览器不支持蓝牙 API";
              statusEl.style.color = "rgba(255, 99, 71, 0.9)";
              console.log("快速蓝牙检测：不支持（API不存在）");
              return;
            }

            // 测试蓝牙API是否真正可用
            try {
              const availability = await navigator.bluetooth.getAvailability();
              
              if (availability) {
                statusEl.innerHTML = "✅ 蓝牙功能可用";
                statusEl.style.color = "rgba(144, 238, 144, 0.9)";
                console.log("快速蓝牙检测：可用");
              } else {
                statusEl.innerHTML = "⚠️ 蓝牙硬件不可用或未开启";
                statusEl.style.color = "rgba(255, 215, 0, 0.9)";
                console.log("快速蓝牙检测：硬件不可用");
              }
            } catch (err) {
              statusEl.innerHTML = "⚠️ 浏览器支持蓝牙，但无法检测硬件状态";
              statusEl.style.color = "rgba(255, 215, 0, 0.9)";
              console.log("快速蓝牙检测：API存在但无法检测硬件");
            }
          } catch (error) {
            statusEl.innerHTML = "❌ 蓝牙检测出错";
            statusEl.style.color = "rgba(255, 99, 71, 0.9)";
            console.error("快速蓝牙检测错误:", error);
          }
        }
        
        // 🚀 立即强制绑定按钮事件 - 解决所有按钮问题
        function forceButtonBinding() {
          console.log("🚀 开始强制按钮绑定...");
          
          // 强制主按钮绑定
          const mainBtn = document.getElementById("main-button");
          if (mainBtn) {
            console.log("✅ 找到主按钮，开始强制绑定");
            
            // 确保按钮可点击
            mainBtn.style.pointerEvents = "auto";
            mainBtn.style.cursor = "pointer";
            mainBtn.disabled = false;
            
            // 强制点击处理器
            const mainClickHandler = function(e) {
              console.log("🎯 主按钮强制点击处理器触发！", e.type);
              e.preventDefault();
              e.stopPropagation();
              
              // 直接调用全局函数，不要延迟
              try {
                if (window.startWaterController) {
                  console.log("✅ 调用全局startWaterController函数");
                  window.startWaterController();
                } else {
                  console.log("❌ 全局函数未准备好，等待加载...");
                  // 等待函数加载，最多尝试3秒
                  let attempts = 0;
                  const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.startWaterController) {
                      console.log("✅ 延迟调用全局函数成功");
                      clearInterval(checkInterval);
                      window.startWaterController();
                    } else if (attempts > 30) { // 30 * 100ms = 3秒
                      clearInterval(checkInterval);
                      console.log("⚠️ 函数加载超时，请刷新页面");
                      alert("蓝牙功能加载中，请稍等片刻后重试，或刷新页面");
                    }
                  }, 100);
                }
              } catch (error) {
                console.error("按钮点击处理出错:", error);
                alert("蓝牙功能启动失败: " + error.message);
              }
            };
            
            // 多重事件绑定
            mainBtn.onclick = mainClickHandler;
            mainBtn.addEventListener("click", mainClickHandler, true);
            mainBtn.addEventListener("mousedown", mainClickHandler, true);
            console.log("✅ 主按钮强制绑定完成");
          }
          
          // 强制清除按钮绑定
          const clearBtn = document.getElementById("clear-pairing-button");
          if (clearBtn) {
            console.log("✅ 找到清除按钮，开始强制绑定");
            
            // 确保按钮可点击
            clearBtn.style.pointerEvents = "auto";
            clearBtn.style.cursor = "pointer";
            clearBtn.disabled = false;
            
            // 强制点击处理器
            const clearClickHandler = function(e) {
              console.log("🧹 清除按钮强制点击处理器触发！", e.type);
              e.preventDefault();
              e.stopPropagation();
              
              // 显示用户反馈
              this.textContent = "清除中...";
              this.disabled = true;
              
              // 使用内联的清除逻辑（临时方案）
              setTimeout(async () => {
                try {
                  if (window.clearPairedDevices) {
                    await window.clearPairedDevices();
                  } else {
                    console.log("⚠️ 主脚本未加载，使用内联清除逻辑");
                    
                    if (!navigator.bluetooth || !navigator.bluetooth.getDevices) {
                      alert("您的浏览器不支持获取已配对设备\n\n请使用Chrome最新版本并启用实验性功能");
                    } else {
                      const devices = await navigator.bluetooth.getDevices();
                      if (devices.length === 0) {
                        alert("没有已配对的蓝牙设备");
                      } else {
                        alert(`找到 ${devices.length} 个设备，功能正在加载中...`);
                      }
                    }
                    
                    this.textContent = "清除已配对设备";
                    this.disabled = false;
                  }
                } catch (error) {
                  console.error("清除设备错误:", error);
                  alert("操作失败: " + error.message);
                  this.textContent = "清除已配对设备";
                  this.disabled = false;
                }
              }, 100);
            };
            
            // 多重事件绑定
            clearBtn.onclick = clearClickHandler;
            clearBtn.addEventListener("click", clearClickHandler, true);
            clearBtn.addEventListener("mousedown", clearClickHandler, true);
            console.log("✅ 清除按钮强制绑定完成");
          }
        }
        
        // 添加调试功能，帮助检测按钮点击
        function setupDebugClick() {
          const btn = document.getElementById("main-button");
          if (btn) {
            console.log("🔍 调试：找到按钮元素", btn);
            btn.addEventListener("click", function(e) {
              console.log("🔍 调试：按钮被点击！", e);
              console.log("🔍 调试：按钮disabled状态:", this.disabled);
              console.log("🔍 调试：按钮样式:", window.getComputedStyle(this));
            }, true); // 使用捕获阶段，优先级更高
          } else {
            console.log("🔍 调试：未找到按钮元素，将重试...");
            setTimeout(setupDebugClick, 100);
          }
        }
        
        // DOM加载完成后立即执行所有初始化
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", function() {
            console.log("🚀 DOM加载完成，开始初始化...");
            quickBluetoothCheck();
            forceButtonBinding();
            setupDebugClick();
          });
        } else {
          console.log("🚀 DOM已就绪，立即初始化...");
          quickBluetoothCheck();
          forceButtonBinding();
          setupDebugClick();
        }
        
        // 🔥 直接在HTML中实现蓝牙功能，避免模块加载问题
        let bluetoothDevice = null;
        let txdCharacteristic = null;
        let rxdCharacteristic = null;
        let isStarted = false;
        let timeoutId = null;
        
        // 更新UI状态
        function updateUi(state) {
          const mainButton = document.getElementById("main-button");
          const deviceName = document.getElementById("device-name");
          
          switch (state) {
            case "pending":
              mainButton.textContent = "请稍候";
              mainButton.disabled = true;
              deviceName.textContent = "已连接：" + (bluetoothDevice ? bluetoothDevice.name : "未知设备");
              break;
            case "ok":
              mainButton.textContent = "结束";
              mainButton.disabled = false;
              break;
            case "standby":
              mainButton.textContent = "开启";
              mainButton.disabled = false;
              deviceName.textContent = "未连接";
              break;
          }
        }
        
        // 处理蓝牙错误
        function handleBluetoothError(error) {
          console.error("蓝牙错误:", error);
          updateUi("standby");
          
          let message = "蓝牙连接失败";
          if (error.message.includes("User cancelled")) {
            return; // 用户取消，不显示错误
          } else if (error.message.includes("not available")) {
            message = "蓝牙不可用，请检查蓝牙是否开启";
          } else if (error.message.includes("No Services")) {
            message = "设备不兼容，请检查设备型号";
          } else {
            message = "连接失败: " + error.message;
          }
          
          alert(message);
        }
        
        // 处理接收到的数据
        async function handleRxdNotifications(event) {
          const value = event.target.value;
          console.log("接收数据:", Array.from(new Uint8Array(value.buffer)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
          
          try {
            let data = new Uint8Array(value.buffer);
            
            // 简化的协议处理
            if (data.length < 4) return;
            
            switch (data[3]) {
              case 0xb0: // 176
              case 0xb1: // 177
                // 握手响应
                setTimeout(async () => {
                  const nameBytes = new TextEncoder().encode(bluetoothDevice.name);
                  const packet = new Uint8Array([0xfe, 0xfe, 0x09, 0xb2, 0x01, ...nameBytes]);
                  await txdCharacteristic.writeValue(packet);
                }, 500);
                break;
                
              case 0xae: // 174
                // 密钥交换响应
                console.log("处理密钥交换");
                break;
                
              case 0xaf: // 175
                // 认证响应
                if (data[5] === 0x55 || data[5] === 0x7a) {
                  const successPacket = new Uint8Array([0xfe, 0xfe, 0x09, 0xb2, 0x01, 0x01, 0x00, 0x00]);
                  setTimeout(() => txdCharacteristic.writeValue(successPacket), 800);
                }
                break;
                
              case 0xb2: // 178
                console.log("🎉 水控器启动成功！");
                clearTimeout(timeoutId);
                isStarted = true;
                updateUi("ok");
                break;
                
              case 0xb3: // 179
                // 结束响应
                updateUi("standby");
                bluetoothDevice.gatt.disconnect();
                break;
            }
          } catch (error) {
            handleBluetoothError(error);
          }
        }
        
        // 启动蓝牙连接
        async function startBluetooth() {
          try {
            if (!navigator.bluetooth) {
              throw new Error("蓝牙API不可用");
            }
            
            bluetoothDevice = await navigator.bluetooth.requestDevice({
              filters: Array.from("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ").map((c) => ({ namePrefix: c })),
              optionalServices: [0xf1f0]
            });

            updateUi("pending");

            const server = await bluetoothDevice.gatt.connect();
            const service = await server.getPrimaryService(0xf1f0);
            txdCharacteristic = await service.getCharacteristic(0xf1f1);
            rxdCharacteristic = await service.getCharacteristic(0xf1f2);

            await rxdCharacteristic.startNotifications();
            rxdCharacteristic.addEventListener("characteristicvaluechanged", handleRxdNotifications);

            // 发送启动数据包
            const startPacket = new Uint8Array([0xfe, 0xfe, 0x09, 0xb0, 0x01, 0x01, 0x00, 0x00]);
            await txdCharacteristic.writeValue(startPacket);
            
            // 设置超时
            timeoutId = setTimeout(() => {
              handleBluetoothError(new Error("连接超时"));
            }, 25000);
            
          } catch (error) {
            handleBluetoothError(error);
          }
        }
        
        // 结束连接
        async function endBluetooth() {
          try {
            const endPacket = new Uint8Array([0xfe, 0xfe, 0x09, 0xb3, 0x00, 0x00]);
            await txdCharacteristic.writeValue(endPacket);
          } catch (error) {
            handleBluetoothError(error);
          }
        }
        
        // 主要的按钮处理函数
        function handleButtonClick() {
          console.log("🚀 handleButtonClick被调用，当前状态:", isStarted);
          isStarted ? endBluetooth() : startBluetooth();
        }
        
        // 🔥 全局暴露函数
        window.startWaterController = handleButtonClick;
        
        console.log("✅ 蓝牙功能已准备就绪");
      })();</script><div class="misc"><button id="install-button">将蓝牙水控器 FOSS 安装到系统</button><p style="font-size:smaller;color:gray;margin:0"><a href="https://github.com/katelya77/watercracker" target="_blank">源代码</a> · <a href="https://github.com/katelya77/watercracker/blob/main/FAQ.md" target="_blank">疑难解答</a> <span id="version"></span><br/><span style="font-size:smaller">copyright (c) 2025 katelya, licensed under MIT License</span></p></div><dialog id="dialog"><header>出现错误</header><form method="dialog"><p id="dialog-content"></p><pre id="dialog-debug-container"><code id="dialog-debug-content"></code></pre><menu style="display:flex;justify-content:flex-end"><button onclick="succeeded = false">好</button></menu></form></dialog></body></html>