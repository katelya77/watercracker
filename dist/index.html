<!doctype html><html lang="zh-CN"><head><meta charset="utf-8"/><meta name="build-version" content="2025-01-08-05"/><meta name="cache-control" content="no-cache, no-store, must-revalidate"/><meta http-equiv="pragma" content="no-cache"/><meta http-equiv="expires" content="0"/><link rel="icon" href="favicon.ico"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="description" content="æ·±åœ³å¸‚å¸¸å·¥ç”µå­&quot;è“ç‰™æ°´æ§å™¨&quot;æ§åˆ¶ç¨‹åºçš„å¼€æºå®ç°ã€‚é€‚ç”¨äºå›½å†…å„å¤§é«˜æ ¡å®¿èˆçƒ­æ°´å™¨ã€‚"/><meta name="theme-color" content="#fafafa"/><link rel="apple-touch-icon" href="logo192.png"/><link rel="manifest" href="manifest.json"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"><title>è“ç‰™æ°´æ§å™¨ FOSS</title><style>body{background:linear-gradient(135deg,#667eea 0,#764ba2 100%)!important;background-attachment:fixed!important;min-height:100vh!important;margin:0!important;padding:0!important;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif!important;overflow-x:hidden!important}.main{position:absolute!important;left:50%!important;top:50%!important;-webkit-transform:translate(-50%,-50%)!important;transform:translate(-50%,-50%)!important;display:flex!important;align-items:center!important;justify-content:center!important;flex-direction:column!important;background:rgba(255,255,255,.15)!important;backdrop-filter:blur(15px)!important;-webkit-backdrop-filter:blur(15px)!important;border-radius:25px!important;padding:40px 50px!important;border:2px solid rgba(255,255,255,.3)!important;box-shadow:0 15px 45px rgba(0,0,0,.2)!important;min-width:350px!important;max-width:500px!important;text-align:center!important;margin:0!important}.main h2{color:#fff!important;text-shadow:0 3px 6px rgba(0,0,0,.4)!important;margin-top:0!important;margin-bottom:15px!important;font-size:28px!important;font-weight:700!important}.main button{background:linear-gradient(45deg,#667eea,#764ba2)!important;color:#fff!important;border:none!important;padding:12px 30px!important;border-radius:25px!important;font-size:16px!important;font-weight:600!important;cursor:pointer!important;transition:all .3s ease!important;box-shadow:0 4px 15px rgba(0,0,0,.2)!important;margin:10px 0!important;pointer-events:auto!important;user-select:none!important;-webkit-user-select:none!important;-webkit-tap-highlight-color:transparent!important;position:relative!important;z-index:1!important}.main button:hover{transform:translateY(-2px)!important;box-shadow:0 8px 25px rgba(0,0,0,.3)!important;background:linear-gradient(45deg,#5a8ff0,#8959b8)!important}.main button:active{transform:translateY(0)!important;box-shadow:0 2px 10px rgba(0,0,0,.2)!important}.main button:disabled{opacity:.6!important;cursor:not-allowed!important;pointer-events:none!important}.main{pointer-events:auto!important}.main p{color:rgba(255,255,255,.9)!important;margin:8px 0!important;font-size:14px!important}.misc{position:fixed!important;bottom:20px!important;left:50%!important;transform:translateX(-50%)!important;text-align:center!important}.misc a{color:rgba(255,255,255,.7)!important;text-decoration:none!important;margin:0 5px!important}.misc a:hover{color:#fff!important;text-decoration:underline!important}</style></head><body><div class="main supported"><noscript>éœ€è¦å¯ç”¨ JavaScriptã€‚</noscript><h2 style="margin-top:0;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,.3)">ğŸ›€ è“ç‰™æ°´æ§å™¨</h2><p id="bluetooth-status" style="color:rgba(255,255,255,.8);font-size:14px;margin:5px 0">æ£€æµ‹è“ç‰™æ”¯æŒä¸­...</p><button id="main-button" onclick="try{window.startWaterController && window.startWaterController(); console.log('âœ…HTMLå†…è”ç‚¹å‡»æˆåŠŸ');}catch(e){console.error('âŒHTMLå†…è”å¤±è´¥:',e);}" data-onclick="startWaterController" style="pointer-events:auto!important;cursor:pointer!important">å¼€å¯</button> <button id="clear-pairing-button" style="background:linear-gradient(45deg,#ff6b6b,#ee5a6f)!important;font-size:14px!important;padding:8px 20px!important;pointer-events:auto!important;cursor:pointer!important" onclick="try{window.clearPairedDevices && window.clearPairedDevices(); console.log('âœ…æ¸…é™¤æŒ‰é’®HTMLå†…è”æˆåŠŸ');}catch(e){console.error('âŒæ¸…é™¤æŒ‰é’®HTMLå†…è”å¤±è´¥:',e);}" data-onclick="clearPairedDevices">æ¸…é™¤å·²é…å¯¹è®¾å¤‡</button><p id="device-name" style="margin-top:10px;margin-bottom:10px">æœªè¿æ¥</p></div><script>// ç«‹å³æ‰§è¡Œè“ç‰™æ£€æµ‹ï¼Œä¸ç­‰å¾…å…¶ä»–è„šæœ¬åŠ è½½
      (function() {
        async function quickBluetoothCheck() {
          const statusEl = document.getElementById("bluetooth-status");
          if (!statusEl) {
            setTimeout(quickBluetoothCheck, 50);
            return;
          }
          
          try {
            // æ›´ä¸¥æ ¼çš„è“ç‰™æ£€æµ‹
            if (typeof navigator === 'undefined' || !navigator.bluetooth) {
              statusEl.innerHTML = "âŒ æµè§ˆå™¨ä¸æ”¯æŒè“ç‰™ API";
              statusEl.style.color = "rgba(255, 99, 71, 0.9)";
              console.log("å¿«é€Ÿè“ç‰™æ£€æµ‹ï¼šä¸æ”¯æŒï¼ˆAPIä¸å­˜åœ¨ï¼‰");
              return;
            }

            // æµ‹è¯•è“ç‰™APIæ˜¯å¦çœŸæ­£å¯ç”¨
            try {
              const availability = await navigator.bluetooth.getAvailability();
              
              if (availability) {
                statusEl.innerHTML = "âœ… è“ç‰™åŠŸèƒ½å¯ç”¨";
                statusEl.style.color = "rgba(144, 238, 144, 0.9)";
                console.log("å¿«é€Ÿè“ç‰™æ£€æµ‹ï¼šå¯ç”¨");
              } else {
                statusEl.innerHTML = "âš ï¸ è“ç‰™ç¡¬ä»¶ä¸å¯ç”¨æˆ–æœªå¼€å¯";
                statusEl.style.color = "rgba(255, 215, 0, 0.9)";
                console.log("å¿«é€Ÿè“ç‰™æ£€æµ‹ï¼šç¡¬ä»¶ä¸å¯ç”¨");
              }
            } catch (err) {
              statusEl.innerHTML = "âš ï¸ æµè§ˆå™¨æ”¯æŒè“ç‰™ï¼Œä½†æ— æ³•æ£€æµ‹ç¡¬ä»¶çŠ¶æ€";
              statusEl.style.color = "rgba(255, 215, 0, 0.9)";
              console.log("å¿«é€Ÿè“ç‰™æ£€æµ‹ï¼šAPIå­˜åœ¨ä½†æ— æ³•æ£€æµ‹ç¡¬ä»¶");
            }
          } catch (error) {
            statusEl.innerHTML = "âŒ è“ç‰™æ£€æµ‹å‡ºé”™";
            statusEl.style.color = "rgba(255, 99, 71, 0.9)";
            console.error("å¿«é€Ÿè“ç‰™æ£€æµ‹é”™è¯¯:", error);
          }
        }
        
        // ğŸš€ ç«‹å³å¼ºåˆ¶ç»‘å®šæŒ‰é’®äº‹ä»¶ - è§£å†³æ‰€æœ‰æŒ‰é’®é—®é¢˜
        function forceButtonBinding() {
          console.log("ğŸš€ å¼€å§‹å¼ºåˆ¶æŒ‰é’®ç»‘å®š...");
          
          // å¼ºåˆ¶ä¸»æŒ‰é’®ç»‘å®š
          const mainBtn = document.getElementById("main-button");
          if (mainBtn) {
            console.log("âœ… æ‰¾åˆ°ä¸»æŒ‰é’®ï¼Œå¼€å§‹å¼ºåˆ¶ç»‘å®š");
            
            // ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
            mainBtn.style.pointerEvents = "auto";
            mainBtn.style.cursor = "pointer";
            mainBtn.disabled = false;
            
            // å¼ºåˆ¶ç‚¹å‡»å¤„ç†å™¨
            const mainClickHandler = function(e) {
              console.log("ğŸ¯ ä¸»æŒ‰é’®å¼ºåˆ¶ç‚¹å‡»å¤„ç†å™¨è§¦å‘ï¼", e.type);
              e.preventDefault();
              e.stopPropagation();
              
              // ç›´æ¥è°ƒç”¨å…¨å±€å‡½æ•°ï¼Œä¸è¦å»¶è¿Ÿ
              try {
                if (window.startWaterController) {
                  console.log("âœ… è°ƒç”¨å…¨å±€startWaterControllerå‡½æ•°");
                  window.startWaterController();
                } else {
                  console.log("âŒ å…¨å±€å‡½æ•°æœªå‡†å¤‡å¥½ï¼Œç­‰å¾…åŠ è½½...");
                  // ç­‰å¾…å‡½æ•°åŠ è½½ï¼Œæœ€å¤šå°è¯•3ç§’
                  let attempts = 0;
                  const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.startWaterController) {
                      console.log("âœ… å»¶è¿Ÿè°ƒç”¨å…¨å±€å‡½æ•°æˆåŠŸ");
                      clearInterval(checkInterval);
                      window.startWaterController();
                    } else if (attempts > 30) { // 30 * 100ms = 3ç§’
                      clearInterval(checkInterval);
                      console.log("âš ï¸ å‡½æ•°åŠ è½½è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢");
                      alert("è“ç‰™åŠŸèƒ½åŠ è½½ä¸­ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»åé‡è¯•ï¼Œæˆ–åˆ·æ–°é¡µé¢");
                    }
                  }, 100);
                }
              } catch (error) {
                console.error("æŒ‰é’®ç‚¹å‡»å¤„ç†å‡ºé”™:", error);
                alert("è“ç‰™åŠŸèƒ½å¯åŠ¨å¤±è´¥: " + error.message);
              }
            };
            
            // å¤šé‡äº‹ä»¶ç»‘å®š
            mainBtn.onclick = mainClickHandler;
            mainBtn.addEventListener("click", mainClickHandler, true);
            mainBtn.addEventListener("mousedown", mainClickHandler, true);
            console.log("âœ… ä¸»æŒ‰é’®å¼ºåˆ¶ç»‘å®šå®Œæˆ");
          }
          
          // å¼ºåˆ¶æ¸…é™¤æŒ‰é’®ç»‘å®š
          const clearBtn = document.getElementById("clear-pairing-button");
          if (clearBtn) {
            console.log("âœ… æ‰¾åˆ°æ¸…é™¤æŒ‰é’®ï¼Œå¼€å§‹å¼ºåˆ¶ç»‘å®š");
            
            // ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
            clearBtn.style.pointerEvents = "auto";
            clearBtn.style.cursor = "pointer";
            clearBtn.disabled = false;
            
            // å¼ºåˆ¶ç‚¹å‡»å¤„ç†å™¨
            const clearClickHandler = function(e) {
              console.log("ğŸ§¹ æ¸…é™¤æŒ‰é’®å¼ºåˆ¶ç‚¹å‡»å¤„ç†å™¨è§¦å‘ï¼", e.type);
              e.preventDefault();
              e.stopPropagation();
              
              // æ˜¾ç¤ºç”¨æˆ·åé¦ˆ
              this.textContent = "æ¸…é™¤ä¸­...";
              this.disabled = true;
              
              // ä½¿ç”¨å†…è”çš„æ¸…é™¤é€»è¾‘ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
              setTimeout(async () => {
                try {
                  if (window.clearPairedDevices) {
                    await window.clearPairedDevices();
                  } else {
                    console.log("âš ï¸ ä¸»è„šæœ¬æœªåŠ è½½ï¼Œä½¿ç”¨å†…è”æ¸…é™¤é€»è¾‘");
                    
                    if (!navigator.bluetooth || !navigator.bluetooth.getDevices) {
                      alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè·å–å·²é…å¯¹è®¾å¤‡\n\nè¯·ä½¿ç”¨Chromeæœ€æ–°ç‰ˆæœ¬å¹¶å¯ç”¨å®éªŒæ€§åŠŸèƒ½");
                    } else {
                      const devices = await navigator.bluetooth.getDevices();
                      if (devices.length === 0) {
                        alert("æ²¡æœ‰å·²é…å¯¹çš„è“ç‰™è®¾å¤‡");
                      } else {
                        alert(`æ‰¾åˆ° ${devices.length} ä¸ªè®¾å¤‡ï¼ŒåŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­...`);
                      }
                    }
                    
                    this.textContent = "æ¸…é™¤å·²é…å¯¹è®¾å¤‡";
                    this.disabled = false;
                  }
                } catch (error) {
                  console.error("æ¸…é™¤è®¾å¤‡é”™è¯¯:", error);
                  alert("æ“ä½œå¤±è´¥: " + error.message);
                  this.textContent = "æ¸…é™¤å·²é…å¯¹è®¾å¤‡";
                  this.disabled = false;
                }
              }, 100);
            };
            
            // å¤šé‡äº‹ä»¶ç»‘å®š
            clearBtn.onclick = clearClickHandler;
            clearBtn.addEventListener("click", clearClickHandler, true);
            clearBtn.addEventListener("mousedown", clearClickHandler, true);
            console.log("âœ… æ¸…é™¤æŒ‰é’®å¼ºåˆ¶ç»‘å®šå®Œæˆ");
          }
        }
        
        // æ·»åŠ è°ƒè¯•åŠŸèƒ½ï¼Œå¸®åŠ©æ£€æµ‹æŒ‰é’®ç‚¹å‡»
        function setupDebugClick() {
          const btn = document.getElementById("main-button");
          if (btn) {
            console.log("ğŸ” è°ƒè¯•ï¼šæ‰¾åˆ°æŒ‰é’®å…ƒç´ ", btn);
            btn.addEventListener("click", function(e) {
              console.log("ğŸ” è°ƒè¯•ï¼šæŒ‰é’®è¢«ç‚¹å‡»ï¼", e);
              console.log("ğŸ” è°ƒè¯•ï¼šæŒ‰é’®disabledçŠ¶æ€:", this.disabled);
              console.log("ğŸ” è°ƒè¯•ï¼šæŒ‰é’®æ ·å¼:", window.getComputedStyle(this));
            }, true); // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œä¼˜å…ˆçº§æ›´é«˜
          } else {
            console.log("ğŸ” è°ƒè¯•ï¼šæœªæ‰¾åˆ°æŒ‰é’®å…ƒç´ ï¼Œå°†é‡è¯•...");
            setTimeout(setupDebugClick, 100);
          }
        }
        
        // DOMåŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œæ‰€æœ‰åˆå§‹åŒ–
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", function() {
            console.log("ğŸš€ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...");
            quickBluetoothCheck();
            forceButtonBinding();
            setupDebugClick();
          });
        } else {
          console.log("ğŸš€ DOMå·²å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–...");
          quickBluetoothCheck();
          forceButtonBinding();
          setupDebugClick();
        }
        
        // ğŸ”¥ ç›´æ¥åœ¨HTMLä¸­å®ç°è“ç‰™åŠŸèƒ½ï¼Œé¿å…æ¨¡å—åŠ è½½é—®é¢˜
        let bluetoothDevice = null;
        let txdCharacteristic = null;
        let rxdCharacteristic = null;
        let isStarted = false;
        let timeoutId = null;
        
        // æ›´æ–°UIçŠ¶æ€
        function updateUi(state) {
          const mainButton = document.getElementById("main-button");
          const deviceName = document.getElementById("device-name");
          
          switch (state) {
            case "pending":
              mainButton.textContent = "è¯·ç¨å€™";
              mainButton.disabled = true;
              deviceName.textContent = "å·²è¿æ¥ï¼š" + (bluetoothDevice ? bluetoothDevice.name : "æœªçŸ¥è®¾å¤‡");
              break;
            case "ok":
              mainButton.textContent = "ç»“æŸ";
              mainButton.disabled = false;
              break;
            case "standby":
              mainButton.textContent = "å¼€å¯";
              mainButton.disabled = false;
              deviceName.textContent = "æœªè¿æ¥";
              break;
          }
        }
        
        // æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•æŠ¥å‘Š
        function showDetailedError(title, errorData, debugInfo = null) {
          const errorReport = `
ğŸ” è°ƒè¯•æŠ¥å‘Š - ${title}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ é”™è¯¯ä¿¡æ¯ï¼š
${errorData.message || errorData}

ğŸ• å‘ç”Ÿæ—¶é—´ï¼š
${new Date().toLocaleString()}

ğŸ“Š è®¾å¤‡ä¿¡æ¯ï¼š
è®¾å¤‡åç§°: ${bluetoothDevice ? bluetoothDevice.name : 'æœªè¿æ¥'}
è®¾å¤‡ID: ${bluetoothDevice ? bluetoothDevice.id : 'æœªçŸ¥'}
è¿æ¥çŠ¶æ€: ${bluetoothDevice && bluetoothDevice.gatt ? (bluetoothDevice.gatt.connected ? 'å·²è¿æ¥' : 'å·²æ–­å¼€') : 'æœªè¿æ¥'}

ğŸ”§ æŠ€æœ¯ç»†èŠ‚ï¼š
${debugInfo ? debugInfo : 'æ— é¢å¤–è°ƒè¯•ä¿¡æ¯'}

ğŸ“‹ å †æ ˆä¿¡æ¯ï¼š
${errorData.stack || 'æ— å †æ ˆä¿¡æ¯'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯·å°†æ­¤æŠ¥å‘Šå‘é€ç»™å¼€å‘è€…è¿›è¡Œåˆ†æ
          `;
          
          // åˆ›å»ºå¯å¤åˆ¶çš„é”™è¯¯æŠ¥å‘Šçª—å£
          const errorWindow = window.open('', '_blank', 'width=600,height=500,scrollbars=yes');
          errorWindow.document.write(`
            <html>
              <head><title>è“ç‰™æ°´æ§å™¨è°ƒè¯•æŠ¥å‘Š</title></head>
              <body style="font-family: monospace; padding: 20px; background: #f5f5f5;">
                <h2 style="color: #d32f2f;">ğŸš¨ è“ç‰™æ°´æ§å™¨è°ƒè¯•æŠ¥å‘Š</h2>
                <button onclick="navigator.clipboard.writeText(document.getElementById('report').innerText)" 
                        style="padding: 10px; background: #1976d2; color: white; border: none; border-radius: 5px; margin-bottom: 20px;">
                  ğŸ“‹ å¤åˆ¶æŠ¥å‘Šåˆ°å‰ªè´´æ¿
                </button>
                <pre id="report" style="background: white; padding: 15px; border-radius: 5px; overflow: auto;">${errorReport}</pre>
                <button onclick="window.close()" style="padding: 10px; background: #666; color: white; border: none; border-radius: 5px;">å…³é—­</button>
              </body>
            </html>
          `);
        }
        
        // å¤„ç†è“ç‰™é”™è¯¯
        function handleBluetoothError(error) {
          console.error("è“ç‰™é”™è¯¯:", error);
          updateUi("standby");
          
          let message = "è“ç‰™è¿æ¥å¤±è´¥";
          let debugInfo = '';
          
          if (error.message.includes("User cancelled")) {
            return; // ç”¨æˆ·å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯
          } else if (error.message.includes("not available")) {
            message = "è“ç‰™ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è“ç‰™æ˜¯å¦å¼€å¯";
          } else if (error.message.includes("No Services")) {
            message = "è®¾å¤‡ä¸å…¼å®¹ï¼Œè¯·æ£€æŸ¥è®¾å¤‡å‹å·";
            debugInfo = 'å¯èƒ½æ˜¯è®¾å¤‡ä¸æ”¯æŒæ‰€éœ€çš„è“ç‰™æœåŠ¡ (0xf1f0)';
          } else if (error.message.includes("è¿æ¥è¶…æ—¶")) {
            message = "è¿æ¥è¶…æ—¶ï¼Œè®¾å¤‡å¯èƒ½ä¸å…¼å®¹æˆ–åè®®ç‰ˆæœ¬ä¸åŒ¹é…";
            debugInfo = `
æ£€æµ‹åˆ°çš„åè®®ç‰¹å¾ï¼š
- å‘ç°äº† 0xfd 0xfd åè®®å¤´ï¼ˆè€Œéæ ‡å‡† 0xfe 0xfeï¼‰
- æ¥æ”¶åˆ°æ¡æ‰‹åŒ…ï¼š0xb0
- æ¥æ”¶åˆ°å¯†é’¥äº¤æ¢åŒ…ï¼š0xae
- ä½†æœªæ”¶åˆ°æœ€ç»ˆç¡®è®¤åŒ…ï¼š0xb2

å»ºè®®æ£€æŸ¥ï¼š
1. è®¾å¤‡æ˜¯å¦ä¸º NEW_V2 æˆ–ç‰¹æ®Šç‰ˆæœ¬å›ºä»¶
2. åè®®å¤´æ˜¯å¦éœ€è¦ä½¿ç”¨ 0xfd 0xfd
3. æ¡æ‰‹åºåˆ—æ˜¯å¦éœ€è¦è°ƒæ•´
            `;
          } else {
            message = "è¿æ¥å¤±è´¥: " + error.message;
          }
          
          // æ˜¾ç¤ºç®€å•æç¤º
          alert(message);
          
          // æ˜¾ç¤ºè¯¦ç»†è°ƒè¯•æŠ¥å‘Š
          showDetailedError("è“ç‰™è¿æ¥é”™è¯¯", error, debugInfo);
        }
        
        // æ£€æµ‹åè®®ç‰ˆæœ¬å¹¶è¿”å›ç›¸åº”çš„åè®®å¤´
        function detectProtocolHeader(data) {
          if (data.length >= 2) {
            if (data[0] === 0xfd && data[1] === 0xfd) {
              return { header: [0xfd, 0xfd], version: 'NEW_V2' };
            } else if (data[0] === 0xfe && data[1] === 0xfe) {
              return { header: [0xfe, 0xfe], version: 'NEW_V1' };
            }
          }
          return { header: [0xfe, 0xfe], version: 'UNKNOWN' };
        }
        
        let detectedProtocol = { header: [0xfe, 0xfe], version: 'NEW_V1' };
        
        // å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®
        async function handleRxdNotifications(event) {
          const value = event.target.value;
          const data = new Uint8Array(value.buffer);
          console.log("æ¥æ”¶æ•°æ®:", Array.from(data).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
          
          try {
            // åŠ¨æ€æ£€æµ‹åè®®ç‰ˆæœ¬
            const protocol = detectProtocolHeader(data);
            if (protocol.version !== 'UNKNOWN') {
              detectedProtocol = protocol;
              console.log(`ğŸ” æ£€æµ‹åˆ°åè®®ç‰ˆæœ¬: ${protocol.version}, åè®®å¤´: [${protocol.header.map(b => '0x' + b.toString(16)).join(', ')}]`);
            }
            
            // ç®€åŒ–çš„åè®®å¤„ç†
            if (data.length < 4) return;
            
            switch (data[3]) {
              case 0xb0: // 176 - æ¡æ‰‹è¯·æ±‚
              case 0xb1: // 177 - æ¡æ‰‹å“åº”
                console.log("ğŸ¤ æ”¶åˆ°æ¡æ‰‹åŒ…ï¼Œå‡†å¤‡å“åº”...");
                setTimeout(async () => {
                  try {
                    // ä½¿ç”¨æ£€æµ‹åˆ°çš„åè®®å¤´
                    const deviceName = bluetoothDevice.name || "WaterController";
                    const nameBytes = new TextEncoder().encode(deviceName);
                    
                    // æ„å»ºå“åº”åŒ…ï¼Œä½¿ç”¨æ£€æµ‹åˆ°çš„åè®®å¤´
                    const packet = new Uint8Array([
                      ...detectedProtocol.header,  // 0xfd,0xfd æˆ– 0xfe,0xfe
                      0x09,                        // é•¿åº¦
                      0xb1,                        // å“åº”ç±»å‹
                      0x01,                        // çŠ¶æ€
                      ...nameBytes.slice(0, 10)    // è®¾å¤‡åç§°ï¼ˆé™åˆ¶é•¿åº¦ï¼‰
                    ]);
                    
                    console.log("ğŸ“¤ å‘é€æ¡æ‰‹å“åº”:", Array.from(packet).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
                    await txdCharacteristic.writeValue(packet);
                  } catch (err) {
                    console.error("æ¡æ‰‹å“åº”å¤±è´¥:", err);
                  }
                }, 500);
                break;
                
              case 0xae: // 174 - å¯†é’¥äº¤æ¢
                console.log("ğŸ” æ”¶åˆ°å¯†é’¥äº¤æ¢åŒ…ï¼Œå‘é€ç¡®è®¤...");
                setTimeout(async () => {
                  try {
                    // å¯†é’¥äº¤æ¢å“åº”
                    const keyPacket = new Uint8Array([
                      ...detectedProtocol.header,  // ä½¿ç”¨æ£€æµ‹åˆ°çš„åè®®å¤´
                      0x09, 0xaf, 0x01, 0x55, 0x00, 0x01, 0x02, 0x03
                    ]);
                    
                    console.log("ğŸ“¤ å‘é€å¯†é’¥äº¤æ¢å“åº”:", Array.from(keyPacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
                    await txdCharacteristic.writeValue(keyPacket);
                  } catch (err) {
                    console.error("å¯†é’¥äº¤æ¢å¤±è´¥:", err);
                  }
                }, 300);
                break;
                
              case 0xaf: // 175 - è®¤è¯å“åº”
                console.log("ğŸ”’ æ”¶åˆ°è®¤è¯åŒ…ï¼Œå‘é€æœ€ç»ˆç¡®è®¤...");
                if (data.length > 5 && (data[5] === 0x55 || data[5] === 0x7a || data[5] === 0x07)) {
                  setTimeout(async () => {
                    try {
                      const successPacket = new Uint8Array([
                        ...detectedProtocol.header,  // ä½¿ç”¨æ£€æµ‹åˆ°çš„åè®®å¤´
                        0x09, 0xb2, 0x01, 0x01, 0x00, 0x00
                      ]);
                      
                      console.log("ğŸ“¤ å‘é€æœ€ç»ˆç¡®è®¤:", Array.from(successPacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
                      await txdCharacteristic.writeValue(successPacket);
                    } catch (err) {
                      console.error("æœ€ç»ˆç¡®è®¤å¤±è´¥:", err);
                    }
                  }, 800);
                }
                break;
                
              case 0xb2: // 178 - æˆåŠŸå“åº”
                console.log("ğŸ‰ æ°´æ§å™¨å¯åŠ¨æˆåŠŸï¼");
                clearTimeout(timeoutId);
                isStarted = true;
                updateUi("ok");
                break;
                
              case 0xb3: // 179 - ç»“æŸå“åº”
                console.log("â¹ï¸ æ”¶åˆ°ç»“æŸå“åº”");
                updateUi("standby");
                bluetoothDevice.gatt.disconnect();
                break;
                
              default:
                console.log(`â“ æœªçŸ¥æ•°æ®åŒ…ç±»å‹: 0x${data[3].toString(16)}`);
            }
          } catch (error) {
            console.error("æ•°æ®å¤„ç†é”™è¯¯:", error);
            handleBluetoothError(error);
          }
        }
        
        // å¯åŠ¨è“ç‰™è¿æ¥
        async function startBluetooth() {
          try {
            if (!navigator.bluetooth) {
              throw new Error("è“ç‰™APIä¸å¯ç”¨");
            }
            
            bluetoothDevice = await navigator.bluetooth.requestDevice({
              filters: Array.from("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ").map((c) => ({ namePrefix: c })),
              optionalServices: [0xf1f0]
            });

            updateUi("pending");

            const server = await bluetoothDevice.gatt.connect();
            const service = await server.getPrimaryService(0xf1f0);
            txdCharacteristic = await service.getCharacteristic(0xf1f1);
            rxdCharacteristic = await service.getCharacteristic(0xf1f2);

            await rxdCharacteristic.startNotifications();
            rxdCharacteristic.addEventListener("characteristicvaluechanged", handleRxdNotifications);

            // å‘é€å¯åŠ¨æ•°æ®åŒ… - å…ˆå°è¯• NEW_V1 åè®®
            console.log("ğŸ“¤ å‘é€åˆå§‹æ¡æ‰‹åŒ…...");
            const startPacket = new Uint8Array([0xfe, 0xfe, 0x09, 0xb0, 0x01, 0x01, 0x00, 0x00]);
            console.log("ğŸ“¤ å‘é€æ•°æ®:", Array.from(startPacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
            await txdCharacteristic.writeValue(startPacket);
            
            // å¦‚æœ5ç§’å†…æ²¡æœ‰å“åº”ï¼Œå°è¯• NEW_V2 åè®® (0xfd 0xfd)
            setTimeout(async () => {
              if (!isStarted && detectedProtocol.version === 'NEW_V1') {
                try {
                  console.log("âš ï¸ NEW_V1 åè®®æ— å“åº”ï¼Œå°è¯• NEW_V2 åè®®...");
                  const v2StartPacket = new Uint8Array([0xfd, 0xfd, 0x09, 0xb0, 0x01, 0x01, 0x00, 0x00]);
                  console.log("ğŸ“¤ å‘é€ NEW_V2 æ¡æ‰‹:", Array.from(v2StartPacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
                  await txdCharacteristic.writeValue(v2StartPacket);
                } catch (err) {
                  console.error("NEW_V2 åè®®å°è¯•å¤±è´¥:", err);
                }
              }
            }, 5000);
            
            // è®¾ç½®è¶…æ—¶
            timeoutId = setTimeout(() => {
              handleBluetoothError(new Error("è¿æ¥è¶…æ—¶"));
            }, 25000);
            
          } catch (error) {
            handleBluetoothError(error);
          }
        }
        
        // ç»“æŸè¿æ¥
        async function endBluetooth() {
          try {
            // ä½¿ç”¨æ£€æµ‹åˆ°çš„åè®®å¤´å‘é€ç»“æŸåŒ…
            const endPacket = new Uint8Array([
              ...detectedProtocol.header,  // ä½¿ç”¨æ£€æµ‹åˆ°çš„åè®®å¤´
              0x09, 0xb3, 0x00, 0x00
            ]);
            console.log("ğŸ“¤ å‘é€ç»“æŸåŒ…:", Array.from(endPacket).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' '));
            await txdCharacteristic.writeValue(endPacket);
          } catch (error) {
            handleBluetoothError(error);
          }
        }
        
        // ä¸»è¦çš„æŒ‰é’®å¤„ç†å‡½æ•°
        function handleButtonClick() {
          console.log("ğŸš€ handleButtonClickè¢«è°ƒç”¨ï¼Œå½“å‰çŠ¶æ€:", isStarted);
          isStarted ? endBluetooth() : startBluetooth();
        }
        
        // ğŸ”¥ å…¨å±€æš´éœ²å‡½æ•°
        window.startWaterController = handleButtonClick;
        
        console.log("âœ… è“ç‰™åŠŸèƒ½å·²å‡†å¤‡å°±ç»ª");
      })();</script><div class="misc"><button id="install-button">å°†è“ç‰™æ°´æ§å™¨ FOSS å®‰è£…åˆ°ç³»ç»Ÿ</button><p style="font-size:smaller;color:gray;margin:0"><a href="https://github.com/katelya77/watercracker" target="_blank">æºä»£ç </a> Â· <a href="https://github.com/katelya77/watercracker/blob/main/FAQ.md" target="_blank">ç–‘éš¾è§£ç­”</a> <span id="version"></span><br/><span style="font-size:smaller">copyright (c) 2025 katelya, licensed under MIT License</span></p></div><dialog id="dialog"><header>å‡ºç°é”™è¯¯</header><form method="dialog"><p id="dialog-content"></p><pre id="dialog-debug-container"><code id="dialog-debug-content"></code></pre><menu style="display:flex;justify-content:flex-end"><button onclick="succeeded = false">å¥½</button></menu></form></dialog></body></html>